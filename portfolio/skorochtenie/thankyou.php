<!doctype html>
<html lang="ru">
<head>
    <link rel="icon" type="image/png" href="img/logo.png"/>
    <link rel="apple-touch-icon" href="img/logo.png"/>
    <meta charset="UTF-8">
    <title>Скорочтение и развитие памяти у детей в Одессе | Методика Шамиля Ахмадуллина </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name='yandex-verification' content='481351fdf25d0bc6'/>

    <link rel="stylesheet" href="css/reset.css"/>
    <link rel="stylesheet" href="css/fonts.css"/>
    <link rel="stylesheet" href="css/jquery.formstyler.css"/>
    <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="js/jquery.bxslider/jquery.bxslider.css"/>
    <link rel="stylesheet" type="text/css" href="js/fancybox/source/jquery.fancybox.css">
</head>
<body>

<!-- Google Tag Manager -->
<noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-5TGFD7"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<script>(function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
            'gtm.start':
                new Date().getTime(), event: 'gtm.js'
        });
        var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
        j.async = true;
        j.src =
            '//www.googletagmanager.com/gtm.js?id=' + i + dl;
        f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-5TGFD7');</script>
<!-- End Google Tag Manager -->

<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script>
    jQuery(document).ready(function () {

        $("#filial").on('change', function () {
            switch ($(this).val()) {
                case '1':
                    $('#val4').css('display', 'none');
                    $('#val2').css('display', 'none');
                    $('#val3').css('display', 'block');
                    $('#val1').css('display', 'block');
                    break;
                case '2':
                    $('#val1').css('display', 'none');
                    $('#val3').css('display', 'none');
                    $('#val2').css('display', 'block');
                    $('#val4').css('display', 'block');
                    break;
            }
            ;
        });

    });
</script>
<header>
    <div class="cont">
        <div class="top">
            <div class="logo">
                <a href="/">
                    <img src="img/logo.png" alt="">
                    <div class="text">
                        <p>Школа СКОРОЧТЕНИЯ</p>
                        <p>и развития памяти</p>
                    </div>
                </a>
            </div>
            <div class="right">

<!--                Выбор филиала: <br/><select id="filial">-->
<!--                    <option value="1">Таирова</option>-->
<!--                    <option value="2">Поселок Котовского</option>-->
<!--                </select>-->


                <div class="tel">
                    <div id="val3">
                        <a href="tel:+38-(094)-94-12-518">(094) 94-12-518</a><br/>
                        <a href="tel:+38-(048)-78-38-518">(048) 78-38-518</a>
                    </div>
                    <div id="val4">
                        <a href="tel:+38-(094)-99-78-834">(094) 99-78-834</a><br/>
                        <a href="tel:+38-(048)-77-24-834">(048) 77-24-834</a>
                    </div>
                </div>
                <div id="val1"><p class="adress">г. Одесса, Люстдорфская дорога 140А</p></div>
                <div id="val2"><p class="adress">г. Одесса, ул. Высоцкого 15</p></div>
            </div>
        </div>
        <div class="menu">
            <ul>
                <li><a href="/">Главная</a></li>
                <li><a href="/courses/">Наши курсы</a></li>

            </ul>
        </div>
    </div>
</header>

<style>

    @media (max-width: 740px) {
        .first {
            height: 170px;
            padding-top: 17px;
        }
    }
</style>

<div class="first">
    <div class="cont">
        <div class="title">
            <h2>Спасибо за обращение</h2>
        </div>
        <div class="text">
            <p>Наши менеджеры свяжутся <br/>с Вами в ближайшее время</p>
        </div>

    </div>
</div>

<footer>
    <div class="cont">
        <div class="top">
            <div class="left">
                <div class="logo">
                    <a href="http://turboread.ru">
                        <img src="img/footLogo.png" alt="">
                        <div class="text">
                            <p>Школа СКОРОЧТЕНИЯ</p>
                            <p>и развития памяти</p>
                        </div>
                    </a>
                </div>
                <div class="menu">
                    <ul>
                        <li><a href="/">Главная</a></li>
                        <li><a href="courses/">Наши курсы</a></li>

                    </ul>
                </div>
            </div>
            <div class="right">
                <div class="callback">
                    <a href="#" style="visibility:hidden;">Подписаться на рассылку</a>
                </div>
                <div class="social">
                    <p>
                        <a href="https://plus.google.com/u/0/communities/118410824239640143202" target="_blank">
                            <img src="img/google-plus-logo-button.png" alt="">
                        </a>
                        <a href="https://ok.ru/group/52833900888266" target="_blank">
                            <img src="img/odnoklassniki-logo.png" alt="">
                        </a>
                        <a href="https://new.vk.com/skorochtenieodesa" target="_blank">
                            <img src="img/vk.png" alt="">
                        </a>
                        <a href="https://www.facebook.com/SKR4E/" target="_blank">
                            <img src="img/fb.png" alt="">
                        </a>
                        <a href="https://www.instagram.com/skorochtenieodessa/" target="_blank">
                            <img src="img/instagram-logo.png" alt="">
                        </a>

                    </p></div>
            </div>
        </div>
        <div class="bottom">
            <div class="left">
                <p>Использование материалов сайта разрешено только с согласия правообладателей.<br/>
                    Мотов Андрей Юрьевич © 2014 - 2020 <a href="http://forumodua.com/showthread.php?t=2727491"
                                                          target="_blank">Мы на Одесском форуме</a></br />
                    Политика конфиденциальности</p>

            </div>
            <div class="right">
                <div class="text">
                    <p>ИНН 2599022497</p>
                    <p>odessa@turboread.ru</p>
                    <p>Все права защищены.</p>
                </div>

            </div>
        </div>
    </div>
</footer>


<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="js/fancybox/source/jquery.fancybox.pack.js"></script>
<script type="text/javascript" src="js/fancybox/source/helpers/jquery.fancybox-media.js?v=1.0.6"></script>

<script src="js/jquery.formstyler.js"></script>
<script src="js/location.js"></script>
<script>
    (function ($) {
        $(function () {
            $('input, select').styler({
                selectSearch: true
            });
        });
    })(jQuery);
</script>
<script src="js/script.js"></script>
</body>

</html>

<?php
function show_form()
{
    ?>

    <?
}

function complete_mail()
{
	
	$expectMarks = array('utm_source','utm_medium','utm_campaign','utm_term','utm_content');$utms=array();foreach($expectMarks as $utm){if(isset($_COOKIE[$utm])){${$utm}=$_COOKIE[$utm];}}

    $leadData = $_POST['DATA'];
    // Получаем данные из форм и сохраняем в массив
    $postData = array(
        '<strong>Имя:</strong>' => $leadData['NAME'],
        '<strong>Телефон:</strong>' => $leadData['PHONE_WORK'],
        '<strong>E-mail:</strong>' => $leadData['EMAIL_WORK'],

        '<strong>Форма:</strong>' => $leadData['number_form'],
        '<strong>utm_source:</strong>' => trim($utm_source),
        '<strong>utm_medium:</strong>' => trim($utm_medium),
        '<strong>utm_campaign:</strong>' => trim($utm_campaign),
        '<strong>utm_content:</strong>' => trim($utm_content),
		'<strong>utm_term:</strong>' => trim($utm_term),

    );
    $strPostData = '';
    foreach ($postData as $key => $value)
        $strPostData .= ($strPostData == '' ? '' : ' ') . $key . ' ' . ($value) . "<br>";
    $str .= "<p><strong>Заявка:</strong> <br/> " . ($strPostData) . "</p>\r\n";
    require 'class.phpmailer.php'; //Дополнительный скрипт для отправки файла, можете не открывать, просто положите рядом с index.html и этим файлом.
	
	
	
    $mail = new PHPMailer();
    $mail->From = 'odessa@turboread.ru';      // от кого
    $mail->FromName = 'Школа скорочтения';   // от кого Имя
    $mail->AddAddress($leadData['emailto'], 'Школа скорочтения'); // кому Ваша почта, Имя
	
	//$mail->AddAddress("maddocs@yandex.ru", 'Школа скорочтения'); // кому Ваша почта, Имя

    $mail->IsHTML(true);        // формат письма HTML
    $mail->Subject = $leadData['number_form'];  // тема письма
    // если есть файл, то прикрепляем его к письму
    if (isset($_FILES['upl'])) {
        if ($_FILES['upl']['error'] == 0) {
            $mail->AddAttachment($_FILES['upl']['tmp_name'], $_FILES['upl']['name']);
        }
    }
    $mail->Body = $str;
    // отправляем наше письмо
    if (!$mail->Send()) die ('Mailer Error: ' . $mail->ErrorInfo);
	
	

#Массив с параметрами, которые нужно передать методом POST к API системы
$user=array(
  'USER_LOGIN'=>'skorochtenie.od@meta.ua', #Ваш логин (электронная почта)
 'USER_HASH'=>'9ebc8c267d80299dece8a173da4c63f863d5345d' #Хэш для доступа к API (смотрите в профиле пользователя)
);
$subdomain='skorochtenieod'; #Наш аккаунт - поддомен
#Формируем ссылку для запроса
$link='https://'.$subdomain.'.amocrm.ru/private/api/auth.php?type=json';
/* Нам необходимо инициировать запрос к серверу. Воспользуемся библиотекой cURL (поставляется в составе PHP). Вы также
можете
использовать и кроссплатформенную программу cURL, если вы не программируете на PHP. */
$curl=curl_init(); #Сохраняем дескриптор сеанса cURL
#Устанавливаем необходимые опции для сеанса cURL
curl_setopt($curl,CURLOPT_RETURNTRANSFER,true);
curl_setopt($curl,CURLOPT_USERAGENT,'amoCRM-API-client/1.0');
curl_setopt($curl,CURLOPT_URL,$link);
curl_setopt($curl,CURLOPT_CUSTOMREQUEST,'POST');
curl_setopt($curl,CURLOPT_POSTFIELDS,json_encode($user));
curl_setopt($curl,CURLOPT_HTTPHEADER,array('Content-Type: application/json'));
curl_setopt($curl,CURLOPT_HEADER,false);
curl_setopt($curl,CURLOPT_COOKIEFILE,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
curl_setopt($curl,CURLOPT_COOKIEJAR,dirname(__FILE__).'/cookie.txt'); #PHP>5.3.6 dirname(__FILE__) -> __DIR__
curl_setopt($curl,CURLOPT_SSL_VERIFYPEER,0);
curl_setopt($curl,CURLOPT_SSL_VERIFYHOST,0);
$out=curl_exec($curl); #Инициируем запрос к API и сохраняем ответ в переменную
$code=curl_getinfo($curl,CURLINFO_HTTP_CODE); #Получим HTTP-код ответа сервера
curl_close($curl); #Завершаем сеанс cURL
/* Теперь мы можем обработать ответ, полученный от сервера. Это пример. Вы можете обработать данные своим способом. */
$code=(int)$code;
$errors=array(
  301=>'Moved permanently',
  400=>'Bad request',
  401=>'Unauthorized',
  403=>'Forbidden',
  404=>'Not found',
  500=>'Internal server error',
  502=>'Bad gateway',
  503=>'Service unavailable'
);
try
{
  #Если код ответа не равен 200 или 204 - возвращаем сообщение об ошибке
 if($code!=200 && $code!=204)
    throw new Exception(isset($errors[$code]) ? $errors[$code] : 'Undescribed error',$code);
}
catch(Exception $E)
{
  die('Ошибка: '.$E->getMessage().PHP_EOL.'Код ошибки: '.$E->getCode());
}
/*
 Данные получаем в формате JSON, поэтому, для получения читаемых данных,
 нам придётся перевести ответ в формат, понятный PHP
 */
$Response=json_decode($out,true);
$Response=$Response['response'];
if(isset($Response['auth'])) #Флаг авторизации доступен в свойстве "auth"
echo("<script>console.log('PHP: " . 'Autho success' . "');</script>");
// return 'Авторизация прошла успешно';
//return 'Авторизация не удалась';


$data = array (
  'add' => 
  array (
    0 => 
    array (
      'name' => ''.$leadData['NAME'].'',
      'custom_fields' => 
      array (
        0 => 
        array (
          'id' => '111707',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$leadData['PHONE_WORK'].'',
              'enum' => 'MOB',
            ),
          ),
        ),
        1 => 
        array (
          'id' => '111709',
          'values' => 
          array (
            0 => 
            array (
              'value' => 'mail',
              'enum' => ''.$leadData['EMAIL_WORK'].'',
            ),
          ),
        ),
      ),
    ),
  ),
);
$link = "https://skorochtenieod.amocrm.ru/api/v2/contacts";

$headers[] = "Accept: application/json";

 //Curl options
$curl = curl_init();
curl_setopt($curl, CURLOPT_RETURNTRANSFER,true);
curl_setopt($curl, CURLOPT_USERAGENT, "amoCRM-API-client-
undefined/2.0");
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($data));
curl_setopt($curl, CURLOPT_URL, $link);
curl_setopt($curl, CURLOPT_HEADER,false);
curl_setopt($curl,CURLOPT_COOKIEFILE,dirname(__FILE__)."/cookie.txt");
curl_setopt($curl,CURLOPT_COOKIEJAR,dirname(__FILE__)."/cookie.txt");
$out = curl_exec($curl);
curl_close($curl);
$result = json_decode($out,TRUE);

$result = preg_match_all('/id\":(.*),/Uis',$out, $login_csrf);
$kod = $login_csrf[1][0]; //KOD 
//-------------создали контакты-----------------

$data = array (
  'add' => 
  array (
    0 => 
    array (
      'name' => ''.$leadData['number_form'].'',
      'contacts_id' => 
      array (
        0 => ''.$kod.'',
      ),
      'custom_fields' => 
      array (
        0 => 
        array (
          'id' => '131469',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$utm_source.'',
            ),
          ),
        ),
        1 => 
        array (
          'id' => '131471',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$utm_medium.'',
            ),
          ),
        ),
        2 => 
        array (
          'id' => '131473',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$utm_campaign.'',
            ),
          ),
        ),
        3 => 
        array (
          'id' => '131475',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$utm_content.'',
            ),
          ),
        ),
		4 => 
        array (
          'id' => '131487',
          'values' => 
          array (
            0 => 
            array (
              'value' => ''.$utm_term.'',
            ),
          ),
        ),
		
      ),
    ),
  ),
);
$link = "https://skorochtenieod.amocrm.ru/api/v2/leads";

$headers[] = "Accept: application/json";

 //Curl options
$curl = curl_init();
curl_setopt($curl, CURLOPT_RETURNTRANSFER,true);
curl_setopt($curl, CURLOPT_USERAGENT, "amoCRM-API-client-
undefined/2.0");
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($data));
curl_setopt($curl, CURLOPT_URL, $link);
curl_setopt($curl, CURLOPT_HEADER,false);
curl_setopt($curl,CURLOPT_COOKIEFILE,dirname(__FILE__)."/cookie.txt");
curl_setopt($curl,CURLOPT_COOKIEJAR,dirname(__FILE__)."/cookie.txt");
$out = curl_exec($curl);
curl_close($curl);
$result = json_decode($out,TRUE);


//=================CRM=============
}

if (!empty($_POST['submit'])) complete_mail();
else show_form();


?>
